<!DOCTYPE html>
<html>
  <head>
    <meta name='viewport' content='width=device-width'/>
    <title>F20 Studio Proto</title>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <script type="module">

      import * as THREE from './build/three.module.js';

      import { WEBGL } from './jsm/WebGL.js';
      import { OrbitControls } from './jsm/controls/OrbitControls.js';
      import { FBXLoader } from './jsm/loaders/FBXLoader.js';

      let scene, camera, controls, renderer;
      let wireMat;
      let dirLight_1, dirLight_2, ambientLight;
      let currentModel, model_0, model_1;
      let modelsLoaded = false;

      const modelOpts = [
        {
          fbxFilename: 'seed-car.fbx',
          camPos: { x: 0, y: 0, z: 150 },
          modelPos: { x: 0, y: -30, z: 0 },
          modelRot: { x: 0, y: 120, z: 0 }
        },
        {
          fbxFilename: 'bark-beetle.fbx',
          camPos: [ 320, 60, 45 ],
          modelPos: [],
          modelRot: []
        }
      ];

      // checkWebGL();
      init();

      // -----------------------------------------------------
      function init() {
        currentModel = modelOpts[0];
      
        setupCamera();
        setupLights();
        setupRenderer();
        setupControls();
        setupScene();

        window.addEventListener( 'resize', onWindowResize, false );
        animate();
      }


      // -----------------------------------------------------
      function setupCamera() {
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1200);
      }


      // -----------------------------------------------------
      function setupControls() {
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = true;
      }


      // -----------------------------------------------------
      function setupLights() {
        dirLight_1 = new THREE.DirectionalLight( 0xffffff );
				dirLight_1.position.set( 1, 1, 1 );
				
        dirLight_2 = new THREE.DirectionalLight( 0x002288 );
				dirLight_2.position.set( -1, -1, -1 );

				ambientLight = new THREE.AmbientLight( 0x222222 );
      }


      // -----------------------------------------------------
      function setupRenderer() {
        renderer = new THREE.WebGLRenderer({
          antialias: true,
          alpha: true
        });

        renderer.setPixelRatio(window.devicePixelRatio * 0.8);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = false;
        renderer.sortObjects       = false;
        renderer.autoClear         = false;
        renderer.setClearColor(0x000000, 0.0); // no longer works? 
        renderer.domElement.id = 'canvas';

        document.body.appendChild(renderer.domElement);
      }


      // -----------------------------------------------------
      function setupScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color( 0x000000 );
      
        wireMat = new THREE.MeshBasicMaterial( {
          color: 0xe0e0ff,
          wireframe: true,
          wireframeLinewidth: 0.1,
          flatShading: true
        });
        
        // prob should be using loader manager
        const loader = new FBXLoader();

        // -----------------------------------------------
        // model_0 = seed-car
        loader.load(`./models/${ modelOpts[0].fbxFilename }`, (fbxData) => {
          // console.log(fbxData);

          fbxData.traverse((child) => {
            if (child.isMesh) {
              child.material = wireMat;
            }
          })
          
          model_0 = fbxData;

          // set default model displayed
          updateModelDisplayed('seed-car');
        });

        // -----------------------------------------------
        // model_1 = bark-beetle
        loader.load(`./models/${ modelOpts[1].fbxFilename }`, (fbxData) => {
          // console.log(fbxData);

          fbxData.traverse((child) => {
            if (child.isMesh) {
              child.material = wireMat;
            }
          })
          
          model_1 = fbxData;
          model_1.rotation.y = -Math.PI;
          model_1.position.y = -45;
        });


        // -----------------------------------------------
        // add lights
        scene.add( dirLight_1 );
        scene.add( dirLight_2 );
        scene.add( ambientLight );

        // -----------------------------------------------
        // TODO raycasting
      }

      // -----------------------------------------------------
      function updateModelDisplayed(model) {
        
        console.log('[ updateModelDisplayed ] model: ', model);

        let newSelectedModel;
        let newSelectedModelOpts; 

        switch (model) {
          case ('seed-car'):
            newSelectedModel = model_0;
            newSelectedModelOpts = modelOpts[0];
            break;

          case ('bark-beetle'):
            newSelectedModel = model_1;
            newSelectedModelOpts = modelOpts[1];
            break;

          default: 
            newSelectedModel = model_0;
            newSelectedModelOpts = modelOpts[0];
        }

        newSelectedModel.position.x = newSelectedModelOpts.modelPos.x;
        newSelectedModel.position.y = newSelectedModelOpts.modelPos.y;
        newSelectedModel.position.z = newSelectedModelOpts.modelPos.z;

        newSelectedModel.rotation.x = newSelectedModelOpts.modelRot.x * THREE.Math.DEG2RAD;
        newSelectedModel.rotation.y = newSelectedModelOpts.modelRot.y * THREE.Math.DEG2RAD;
        newSelectedModel.rotation.z = newSelectedModelOpts.modelRot.z * THREE.Math.DEG2RAD;

        camera.position.x = newSelectedModelOpts.camPos.x;
        camera.position.y = newSelectedModelOpts.camPos.y;
        camera.position.z = newSelectedModelOpts.camPos.z; 

        controls.update();
        scene.add(newSelectedModel);
        camera.lookAt(newSelectedModel.position);
      } 

      // -----------------------------------------------------
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.clear();
        renderer.render(scene, camera);
      }


      // -----------------------------------------------------
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }


      // -----------------------------------------------------
      function checkWebGL() {
        if ( WEBGL.isWebGLAvailable() ) {
          init();
        } else {
          const warning = WEBGL.getWebGLErrorMessage();
          alert('WebGL Error: ', warning);
        }
      }
    
    </script>
  </body>
</html>